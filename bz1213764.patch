diff -Naurp pcp-3.10.3.orig/qa/805 pcp-3.10.3/qa/805
--- pcp-3.10.3.orig/qa/805	1970-01-01 10:00:00.000000000 +1000
+++ pcp-3.10.3/qa/805	2015-05-04 18:20:20.317329911 +1000
@@ -0,0 +1,86 @@
+#!/bin/sh
+# PCP QA Test No. 805
+# Exercise the postfix PMDA.
+#
+# Copyright (c) 2015 Red Hat.  All Rights Reserved.
+#
+
+seq=`basename $0`
+echo "QA output created by $seq"
+
+# get standard environment, filters and checks
+. ./common.product
+. ./common.filter
+. ./common.check
+
+which qshape >/dev/null 2>&1 || _notrun "No qshape binary installed"
+[ -f "$PCP_PMDAS_DIR/postfix/pmdapostfix.pl" ] || _notrun "No postfix PMDA"
+
+status=1	# failure is the default!
+$sudo rm -rf $tmp.* $seq.full
+
+# prepare the PMDAs test environment
+cp $here/postfix/qshape.sh $tmp.qshape
+$sudo chown root:root $tmp.qshape
+$sudo chmod 755 $tmp.qshape
+touch $tmp.logfile
+
+export PMDA_POSTFIX_LOG=$tmp.logfile
+export PMDA_POSTFIX_REFRESH=1
+export PMDA_POSTFIX_QSHAPE=$tmp.qshape
+
+pmdapostfix_remove()
+{
+    echo
+    echo "=== remove postfix agent ==="
+    $sudo ./Remove >$tmp.out 2>&1
+    _filter_pmda_remove <$tmp.out
+}
+
+pmdapostfix_install()
+{
+    # start from known starting points
+    cd $PCP_PMDAS_DIR/postfix
+    $sudo ./Remove >/dev/null 2>&1
+    $sudo $PCP_RC_DIR/pmcd stop 2>&1 | _filter_pcp_stop
+
+    echo
+    echo "=== postfix agent installation ==="
+    $sudo ./Install </dev/null >$tmp.out 2>&1
+    cat $tmp.out >>$here/$seq.full
+    # Check postfix metrics have appeared ... X metrics and Y values
+    _filter_pmda_install <$tmp.out \
+    | sed \
+        -e '/^Waiting for pmcd/s/\.\.\.[. ]*$/DOTS/' \
+        -e 's/[0-9][0-9]* warnings, //' \
+    | $PCP_AWK_PROG '
+/Check postfix metrics have appeared/   { if ($7 >= 7) $7 = "X"
+                                          if ($10 >= 50) $10 = "Y"
+                                        }
+                                        { print }'
+}
+
+_prepare_pmda postfix
+trap "_cleanup_pmda postfix; exit \$status" 0 1 2 3 15
+
+# real QA test starts here
+pmdapostfix_install
+
+metrics=`pminfo postfix | LC_COLLATE=POSIX sort`
+
+for file in $here/postfix/*-log-*gz
+do
+    pmsleep 1.25
+    logfile=`basename $file`
+    gunzip < $file > $tmp.logfile
+
+    echo "=== verify postfix values - $logfile ==="
+    pminfo -f $metrics
+    echo "=== done ==="
+    echo
+done
+$sudo rm -f $tmp.logfile $tmp.qshape
+
+pmdapostfix_remove
+status=0
+exit
diff -Naurp pcp-3.10.3.orig/qa/805.out pcp-3.10.3/qa/805.out
--- pcp-3.10.3.orig/qa/805.out	1970-01-01 10:00:00.000000000 +1000
+++ pcp-3.10.3/qa/805.out	2015-05-04 18:20:20.321329913 +1000
@@ -0,0 +1,179 @@
+QA output created by 805
+Waiting for pmcd to terminate ...
+
+=== postfix agent installation ===
+You will need to choose an appropriate configuration for installation of
+the "postfix" Performance Metrics Domain Agent (PMDA).
+
+  collector	collect performance statistics on this system
+  monitor	allow this system to monitor local and/or remote systems
+  both		collector and monitor configuration for this system
+
+Please enter c(ollector) or m(onitor) or b(oth) [b] Updating the Performance Metrics Name Space (PMNS) ...
+Terminate PMDA if already installed ...
+[...install files, make output...]
+Updating the PMCD control file, and notifying PMCD ...
+Starting pmcd ... 
+Starting pmlogger ... 
+Check postfix metrics have appeared ... X metrics and Y values
+=== verify postfix values - postfix-log-001.gz ===
+
+postfix.queues.active
+    inst [0 or "total"] value 0
+    inst [1 or "0-5 mins"] value 1
+    inst [2 or "5-10 mins"] value 0
+    inst [3 or "10-20 mins"] value 1
+    inst [4 or "20-40 mins"] value 0
+    inst [5 or "40-80 mins"] value 1
+    inst [6 or "80-160 mins"] value 0
+    inst [7 or "160-320 mins"] value 1
+    inst [8 or "320-640 mins"] value 0
+    inst [9 or "640-1280 mins"] value 1
+    inst [10 or "1280+ mins"] value 10
+
+postfix.queues.deferred
+    inst [0 or "total"] value 10
+    inst [1 or "0-5 mins"] value 9
+    inst [2 or "5-10 mins"] value 8
+    inst [3 or "10-20 mins"] value 7
+    inst [4 or "20-40 mins"] value 6
+    inst [5 or "40-80 mins"] value 5
+    inst [6 or "80-160 mins"] value 4
+    inst [7 or "160-320 mins"] value 3
+    inst [8 or "320-640 mins"] value 2
+    inst [9 or "640-1280 mins"] value 1
+    inst [10 or "1280+ mins"] value 0
+
+postfix.queues.hold
+    inst [0 or "total"] value 10
+    inst [1 or "0-5 mins"] value 9
+    inst [2 or "5-10 mins"] value 8
+    inst [3 or "10-20 mins"] value 7
+    inst [4 or "20-40 mins"] value 6
+    inst [5 or "40-80 mins"] value 5
+    inst [6 or "80-160 mins"] value 4
+    inst [7 or "160-320 mins"] value 3
+    inst [8 or "320-640 mins"] value 2
+    inst [9 or "640-1280 mins"] value 1
+    inst [10 or "1280+ mins"] value 0
+
+postfix.queues.incoming
+    inst [0 or "total"] value 9
+    inst [1 or "0-5 mins"] value 0
+    inst [2 or "5-10 mins"] value 1
+    inst [3 or "10-20 mins"] value 2
+    inst [4 or "20-40 mins"] value 3
+    inst [5 or "40-80 mins"] value 4
+    inst [6 or "80-160 mins"] value 5
+    inst [7 or "160-320 mins"] value 6
+    inst [8 or "320-640 mins"] value 7
+    inst [9 or "640-1280 mins"] value 8
+    inst [10 or "1280+ mins"] value 9
+
+postfix.queues.maildrop
+    inst [0 or "total"] value 0
+    inst [1 or "0-5 mins"] value 1
+    inst [2 or "5-10 mins"] value 2
+    inst [3 or "10-20 mins"] value 3
+    inst [4 or "20-40 mins"] value 4
+    inst [5 or "40-80 mins"] value 5
+    inst [6 or "80-160 mins"] value 6
+    inst [7 or "160-320 mins"] value 7
+    inst [8 or "320-640 mins"] value 8
+    inst [9 or "640-1280 mins"] value 9
+    inst [10 or "1280+ mins"] value 10
+
+postfix.received
+    inst [0 or "local"] value 0
+    inst [1 or "smtp"] value 0
+
+postfix.sent
+    inst [0 or "smtp"] value 0
+=== done ===
+
+=== verify postfix values - postfix-log-002.gz ===
+
+postfix.queues.active
+    inst [0 or "total"] value 0
+    inst [1 or "0-5 mins"] value 1
+    inst [2 or "5-10 mins"] value 0
+    inst [3 or "10-20 mins"] value 1
+    inst [4 or "20-40 mins"] value 0
+    inst [5 or "40-80 mins"] value 1
+    inst [6 or "80-160 mins"] value 0
+    inst [7 or "160-320 mins"] value 1
+    inst [8 or "320-640 mins"] value 0
+    inst [9 or "640-1280 mins"] value 1
+    inst [10 or "1280+ mins"] value 10
+
+postfix.queues.deferred
+    inst [0 or "total"] value 10
+    inst [1 or "0-5 mins"] value 9
+    inst [2 or "5-10 mins"] value 8
+    inst [3 or "10-20 mins"] value 7
+    inst [4 or "20-40 mins"] value 6
+    inst [5 or "40-80 mins"] value 5
+    inst [6 or "80-160 mins"] value 4
+    inst [7 or "160-320 mins"] value 3
+    inst [8 or "320-640 mins"] value 2
+    inst [9 or "640-1280 mins"] value 1
+    inst [10 or "1280+ mins"] value 0
+
+postfix.queues.hold
+    inst [0 or "total"] value 10
+    inst [1 or "0-5 mins"] value 9
+    inst [2 or "5-10 mins"] value 8
+    inst [3 or "10-20 mins"] value 7
+    inst [4 or "20-40 mins"] value 6
+    inst [5 or "40-80 mins"] value 5
+    inst [6 or "80-160 mins"] value 4
+    inst [7 or "160-320 mins"] value 3
+    inst [8 or "320-640 mins"] value 2
+    inst [9 or "640-1280 mins"] value 1
+    inst [10 or "1280+ mins"] value 0
+
+postfix.queues.incoming
+    inst [0 or "total"] value 9
+    inst [1 or "0-5 mins"] value 0
+    inst [2 or "5-10 mins"] value 1
+    inst [3 or "10-20 mins"] value 2
+    inst [4 or "20-40 mins"] value 3
+    inst [5 or "40-80 mins"] value 4
+    inst [6 or "80-160 mins"] value 5
+    inst [7 or "160-320 mins"] value 6
+    inst [8 or "320-640 mins"] value 7
+    inst [9 or "640-1280 mins"] value 8
+    inst [10 or "1280+ mins"] value 9
+
+postfix.queues.maildrop
+    inst [0 or "total"] value 0
+    inst [1 or "0-5 mins"] value 1
+    inst [2 or "5-10 mins"] value 2
+    inst [3 or "10-20 mins"] value 3
+    inst [4 or "20-40 mins"] value 4
+    inst [5 or "40-80 mins"] value 5
+    inst [6 or "80-160 mins"] value 6
+    inst [7 or "160-320 mins"] value 7
+    inst [8 or "320-640 mins"] value 8
+    inst [9 or "640-1280 mins"] value 9
+    inst [10 or "1280+ mins"] value 10
+
+postfix.received
+    inst [0 or "local"] value 1
+    inst [1 or "smtp"] value 0
+
+postfix.sent
+    inst [0 or "smtp"] value 0
+    inst [1 or "local"] value 1
+=== done ===
+
+
+=== remove postfix agent ===
+Culling the Performance Metrics Name Space ...
+postfix ... done
+Updating the PMCD control file, and notifying PMCD ...
+[...removing files...]
+Check postfix metrics have gone away ... OK
+Waiting for pmcd to terminate ...
+Starting pmcd ... 
+Starting pmlogger ... 
diff -Naurp pcp-3.10.3.orig/qa/common.filter pcp-3.10.3/qa/common.filter
--- pcp-3.10.3.orig/qa/common.filter	2015-01-24 07:23:07.000000000 +1100
+++ pcp-3.10.3/qa/common.filter	2015-05-04 18:20:20.321329913 +1000
@@ -333,6 +333,7 @@ _filter_top_pmns()
 	-e '/^    oracle /d' \
 	-e '/^    oraping /d' \
 	-e '/^    pdns /d' \
+	-e '/^    postfix /d' \
 	-e '/^    postgresql /d' \
 	-e '/^    proc /d' \
 	-e '/^    rpm /d' \
diff -Naurp pcp-3.10.3.orig/qa/GNUmakefile pcp-3.10.3/qa/GNUmakefile
--- pcp-3.10.3.orig/qa/GNUmakefile	2015-03-03 07:07:15.000000000 +1100
+++ pcp-3.10.3/qa/GNUmakefile	2015-05-04 18:20:20.321329913 +1000
@@ -15,7 +15,8 @@ TESTDIR = $(PCP_VAR_DIR)/testsuite
 TESTS	= $(shell sed -n -e '/^[0-9]/s/:retired//' -e '/^[0-9]/s/:reserved//' -e '/^[0-9]/s/[        ].*//' -e '/^[0-9]/p' <group)
 
 SUBDIRS = src pmdas cisco gluster pconf sadist collectl secure nfsclient \
-	  archives views qt linux perfevent unbound cifs gpfs lustre ganglia
+	  archives views qt linux perfevent unbound cifs gpfs lustre ganglia \
+	  postfix
 ifeq "$(ENABLE_PYTHON)" "true"
 SUBDIRS += secure
 endif
diff -Naurp pcp-3.10.3.orig/qa/group pcp-3.10.3/qa/group
--- pcp-3.10.3.orig/qa/group	2015-05-04 18:19:39.069305010 +1000
+++ pcp-3.10.3/qa/group	2015-05-04 18:20:20.322329914 +1000
@@ -168,6 +168,7 @@ pmda.news
 pmda.nvidia
 pmda.papi
 pmda.pmcd
+pmda.postfix
 pmda.proc
 pmda.rsyslog
 pmda.sample
@@ -975,6 +976,7 @@ cgroups
 798 pmda.nfsclient local
 799:retired pmda.papi local
 800 pmda.proc local
+805 pmda.postfix local
 813 pmda.papi local
 815 pmie local
 822:reserved pmlogrewrite
diff -Naurp pcp-3.10.3.orig/qa/postfix/GNUmakefile pcp-3.10.3/qa/postfix/GNUmakefile
--- pcp-3.10.3.orig/qa/postfix/GNUmakefile	1970-01-01 10:00:00.000000000 +1000
+++ pcp-3.10.3/qa/postfix/GNUmakefile	2015-05-04 18:20:20.322329914 +1000
@@ -0,0 +1,17 @@
+TOPDIR = ../..
+include $(TOPDIR)/src/include/builddefs
+
+SCRIPT = qshape.sh
+TESTDIR = $(PCP_VAR_DIR)/testsuite/postfix
+LOGFILES = $(shell echo *-log-*.gz)
+
+default setup default_pcp:
+
+install install_pcp: $(ROOTFILES)
+	$(INSTALL) -m 755 -d $(TESTDIR)
+	$(INSTALL) -m 755 $(SCRIPT) $(TESTDIR)/$(SCRIPT)
+	$(INSTALL) -m 644 $(LOGFILES) $(TESTDIR)
+	$(INSTALL) -m 644 GNUmakefile.install $(TESTDIR)/GNUmakefile
+
+include $(BUILDRULES)
+
diff -Naurp pcp-3.10.3.orig/qa/postfix/GNUmakefile.install pcp-3.10.3/qa/postfix/GNUmakefile.install
--- pcp-3.10.3.orig/qa/postfix/GNUmakefile.install	1970-01-01 10:00:00.000000000 +1000
+++ pcp-3.10.3/qa/postfix/GNUmakefile.install	2015-05-04 18:20:20.322329914 +1000
@@ -0,0 +1 @@
+default setup install:
diff -Naurp pcp-3.10.3.orig/qa/postfix/postfix-log-001.gz pcp-3.10.3/qa/postfix/postfix-log-001.gz
--- pcp-3.10.3.orig/qa/postfix/postfix-log-001.gz	1970-01-01 10:00:00.000000000 +1000
+++ pcp-3.10.3/qa/postfix/postfix-log-001.gz	2015-05-04 18:20:30.392335993 +1000
@@ -0,0 +1,2 @@
+ãMÌFUpostfix-log-001 ≠êÀNƒ0E˜|Eˆ–‘è8GwàE5ì©"1-j‚ÛI%ªŒH∞≥,˚ùKÄ“ÅÎêL*†ú¨§Hî¿|‰u ÊmŸÍ•|ˆ◊q´y}é¬ãö6^À<÷2OfôÕV¶y|5(ÙìÍ$u¢¿6pﬁ•"F-ˆ<ÊÎW«µÊ≥È∫˝|+mE—Úì9-Û•LÔkC∑müÎ©ˇŒ˙Eá]»yeo9DJt˙¶¡ AUú%h=π√ûÑ‰øÑôpÔ“ÿ≥ó;»∑}‚Ä¢ƒ
+∑Ø√ö‚ü}æ !êMÊr  
\ No newline at end of file
diff -Naurp pcp-3.10.3.orig/qa/postfix/postfix-log-002.gz pcp-3.10.3/qa/postfix/postfix-log-002.gz
--- pcp-3.10.3.orig/qa/postfix/postfix-log-002.gz	1970-01-01 10:00:00.000000000 +1000
+++ pcp-3.10.3/qa/postfix/postfix-log-002.gz	2015-05-04 18:20:30.398335997 +1000
@@ -0,0 +1,2 @@
+ãMÌFUpostfix-log-002 ≠ï_k€0≈ﬂ˜)DŸC«EWíı«ƒcÌñáΩtÀ√†å!≈3ãÌ‘V ∂Oﬂ´–—4víñQƒÂ‹sØŒèp…ò…17sŒSiSn®ê÷æñ2Fn}[x≤n∫∞,ˇL*◊ﬂ^[Ä‰GJXïµe]ê¶&]Y‘nE y√ˇ´⁄9®T î3 √é©j•™.úØ¢Zpm2«ÍÆƒ+N®ëº©óe±i±3ﬁN|»'˜RùÅ DJÉù◊e˛{≥∆Œ&vV≥KÄâãœÊ2%õrë1≤lõ*õ∂M>ä+ëÄ+_yWo’-Ô©WæÎ\·«ÿduô‰ñ))£‰N·«≠$uyÂiﬁT<hºL=‹TE\¨—=ÉÌ˜·K˛ÛôPjDÍ6_á»˘Õ∆o<qy(o˝ª¯6Fòd86´&w´k≠%ÎŸM6≈˝ru◊˜—¥eÒ3Vl˜?"≠_πøŸVmD€ ﬁü:<N0fb¬‚ó¡ÎÆŒ8eîçbò¬¶À:_réÂ8DãŸ
+f©™\ΩH…∫mÚ ï+2v‰ÏÌÏ˚|vıÌÀ◊´≥C√J≠ÿ3Wﬁb∞o˝‚ë†N%jj4ÃÁO¿„t¯Å93©:ÃΩ1Ê®™ñ˙u†{‹áPG°”*v˛d.î¿Å∫Ñ√–ÌâKeÿ	Ëê∫ûz:¡8%w@∑Î0⁄Hy$ÅûÅì–IaO@∑ÎBP&¨ë…1ËáûçóB«†„iSÄ–ÂØÕ‹ﬁ¨2>Ÿ37˛òπ≠ BÃÒèŒRfë˚:N3'£M$ô+™pù'9y1swÖs8Mπ  
\ No newline at end of file
diff -Naurp pcp-3.10.3.orig/qa/postfix/qshape.sh pcp-3.10.3/qa/postfix/qshape.sh
--- pcp-3.10.3.orig/qa/postfix/qshape.sh	1970-01-01 10:00:00.000000000 +1000
+++ pcp-3.10.3/qa/postfix/qshape.sh	2015-05-04 18:20:20.322329914 +1000
@@ -0,0 +1,38 @@
+#! /bin/sh
+
+queue="$1"
+case "$queue" in
+hold)
+	cat <<EOF
+                                         T  5 10 20 40 80 160 320 640 1280 1280+
+                                  TOTAL 10  9  8  7  6  5   4   3   2    1     0
+EOF
+	;;
+
+active)
+	cat <<EOF
+                                         T  5 10 20 40 80 160 320 640 1280 1280+
+                                  TOTAL  0  1  0  1  0  1   0   1   0    1    10
+EOF
+	;;
+incoming)
+	cat <<EOF
+                                         T  5 10 20 40 80 160 320 640 1280 1280+
+                                  TOTAL  9  0  1  2  3  4   5   6   7    8     9
+EOF
+	;;
+deferred)
+	cat <<EOF
+                                         T  5 10 20 40 80 160 320 640 1280 1280+
+                                  TOTAL 10  9  8  7  6  5   4   3   2    1     0
+EOF
+	;;
+maildrop)
+	cat <<EOF
+                                         T  5 10 20 40 80 160 320 640 1280 1280+
+                                  TOTAL  0  1  2  3  4  5   6   7   8    9    10
+EOF
+	;;
+*)
+ 	echo "Unrecognised queue name: $queue" 1>&2
+esac
diff -Naurp pcp-3.10.3.orig/src/pmdas/postfix/pmdapostfix.pl pcp-3.10.3/src/pmdas/postfix/pmdapostfix.pl
--- pcp-3.10.3.orig/src/pmdas/postfix/pmdapostfix.pl	2015-05-04 18:19:57.138315918 +1000
+++ pcp-3.10.3/src/pmdas/postfix/pmdapostfix.pl	2015-05-04 18:20:20.323329915 +1000
@@ -1,5 +1,5 @@
 #
-# Copyright (c) 2012,2014 Red Hat.
+# Copyright (c) 2012-2015 Red Hat.
 # Copyright (c) 2009-2010 Josef 'Jeff' Sipek <jeffpc@josefsipek.net>
 #
 # This program is free software; you can redistribute it and/or modify it
@@ -95,10 +95,18 @@ sub postfix_do_refresh
 sub postfix_log_parser
 {
     ( undef, $_ ) = @_;
+    my $do_sent = 0;
 
     if (/status=sent/) {
 	return unless (/ postfix\//);
+	$do_sent = 1;
+    }
+    elsif (/stat=Sent/) {
+	return unless (/relay=[^,]+/);
+	$do_sent = 1;
+    }
 
+    if ($do_sent == 1) {
 	my $relay = "";
 
 	if (/relay=([^,]+)/o) {
@@ -204,6 +212,9 @@ foreach my $file ( @logfiles ) {
 	$logfile = $file;
     }
 }
+if (defined($ENV{'PMDA_POSTFIX_LOG'})) { $logfile = $ENV{'PMDA_POSTFIX_LOG'}; }
+if (defined($ENV{'PMDA_POSTFIX_QSHAPE'})) { $qshape = $ENV{'PMDA_POSTFIX_QSHAPE'}; }
+if (defined($ENV{'PMDA_POSTFIX_REFRESH'})) { $refresh = $ENV{'PMDA_POSTFIX_REFRESH'}; }
 die 'No Postfix log file found' unless defined($logfile);
 
 $pmda->add_indom($postfix_queues_indom, \@postfix_queues_dom, '', '');
